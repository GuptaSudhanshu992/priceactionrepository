{% extends 'blog/base.html' %}

{% block sectionheading %}Welcome Back!{% endblock sectionheading %}
{% block subsectionheading %}Login to your account and continue where you left off{% endblock subsectionheading %}

{% block content %}
	<div class="row justify-content-center mt-5 mb-5">
		<div class="col-md-6">
			<form action="{% url 'login' %}" method="POST" id="login-form">
				{% csrf_token %}
				<div class="form-group">
					<input type="email" class="form-control" id="email" name="email" placeholder="Enter your email" required>
				</div>
				<div class="form-group">
					<div class="input-group">
						<input type="password" class="form-control" id="password" name="password" placeholder="Enter your password">
						<div class="input-group-append">
							<span class="input-group-text btn-outline-secondary" style="cursor: pointer;" id="togglePassword" onclick="togglePasswordVisibility('password','toggleIcon')">
								<i class="fa fa-eye" id="toggleIcon"></i>
							</span>
						</div>
					</div>
				</div>
				<button type="submit" class="btn btn-success btn-block" id="login-btn">Login</button>
			</form>
			<div class="text-right mt-2">
				<a class="text-success" href="{% url 'forgotpassword' %}">Forgot Password?</a>
			</div>
			<hr>
			<div class="text-center">
				<p>Or login using</p>
				<div class="d-flex flex-row">
					<a href="{% url 'social:begin' 'google-oauth2' %}?next={{ request.path }}" class="btn btn-danger mr-2 flex-grow-1" aria-label="Login with Google">
						<i class="fab fa-google"></i>
					</a>
					<a href="" class="btn btn-primary mr-2 flex-grow-1" aria-label="Login with Facebook">
						<i class="fab fa-facebook-f"></i>
					</a><!-- class="" -->
					<a href="" class="g-signin2 btn btn-dark flex-grow-1" aria-label="Login with Apple">
						<i class="fab fa-apple"></i>
					</a>
				</div>
			</div>
			<div class="text-center mt-3 mb-5">
				<p>Don't have an account? <a class="text-success" href="{% url 'register' %}">Register here</a></p>
			</div>
		</div>
	</div>
{% endblock content %}

{% block script %}
	<script>
		function onSignIn(googleUser) {
		  var profile = googleUser.getBasicProfile();
		  console.log('ID: ' + profile.getId()); // Do not send to your backend! Use an ID token instead.
		  console.log('Name: ' + profile.getName());
		  console.log('Image URL: ' + profile.getImageUrl());
		  console.log('Email: ' + profile.getEmail()); // This is null if the 'email' scope is not present.
		}

	  function signOut() {
		var auth2 = gapi.auth2.getAuthInstance();
		auth2.signOut().then(function () {
		  console.log('User signed out.');
		});
	  }

		document.getElementById('login-form').addEventListener('submit', async function(event) {
			event.preventDefault();
			
			const button = document.getElementById('login-btn');
			const email = document.getElementById('email').value;
			const password = document.getElementById('password').value;
			const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
			const referrer = isReferrerFromCurrentDomain(document.referrer) ? document.referrer : window.location.origin;
			const response_message = document.getElementById('response_messages')
			
			response_message.innerHTML="";
			response_message.style.display="none";
			response_message.classList.remove('alert-success');
			response_message.classList.remove('alert-danger');
			
			button.disabled = true;
			button.className = 'btn btn-success btn-block';
			button.innerHTML = 'Logging in... <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

			try {
				const response = await fetch("{% url 'login' %}", {
					method: 'POST',
					headers: {
						'Content-Type': 'application/x-www-form-urlencoded',
						'X-CSRFToken': csrfToken
					},
					body: new URLSearchParams({
						email: email,
						password: password,
						referrer: referrer
					})
				});

				const data = await response.json();

				if (data.success) {
					response_message.innerHTML=data.message;
					response_message.style.display="block";
					response_message.classList.add('alert-success');
					setTimeout(() => {
						window.location.href = data.redirect_url;
					}, 3000);
				} else {
					console.log('Login attempt failed!');
					button.disabled = false;
					button.innerHTML = 'Login';
					response_message.innerHTML=data.message;
					response_message.style.display="block";
					response_message.classList.add('alert-danger');
				}
			} catch (error) {
				console.error('Request error:', error);
				button.disabled = false;
				button.innerHTML = 'Login';
				response_message.innerHTML='Unexpected error has occurred, please refresh the page and try again...';
				response_message.style.display="block";
				response_message.classList.add('alert-danger');
			}
		});
	</script>
{% endblock script %}
